import nmap
import json
import psycopg2
from psycopg2 import sql

# Load configuration
with open('config.json', 'r') as f:
    config = json.load(f)

subnets = config['subnets']
db_config = config['database']

def scan_network(subnet):
    """Scan the given subnet using Nmap with the vuln script."""
    nm = nmap.PortScanner()
    print(f"Scanning subnet: {subnet}")
    try:
        nm.scan(hosts=subnet, arguments='--script vuln')
    except Exception as e:
        print(f"Error running Nmap: {e}")
        return

    # Parse and store results in the database
    for host in nm.all_hosts():
        if nm[host].state() == 'up':
            open_ports = []
            vulns = []
            for proto in nm[host].all_protocols():
                for port in nm[host][proto].keys():
                    if nm[host][proto][port]['state'] == 'open':
                        open_ports.append(str(port))
                        if 'script' in nm[host][proto][port]:
                            vulns.append(nm[host][proto][port]['script'])

            try:
                conn = psycopg2.connect(
                    host=db_config['host'],
                    port=db_config['port'],
                    database=db_config['name'],
                    user=db_config['user'],
                    password=db_config['password']
                )
                cur = conn.cursor()
                cur.execute(
                    sql.SQL(
                        """
                        INSERT INTO scan_results (ip, open_ports, vulnerabilities)
                        VALUES (%s, %s, %s)
                        """
                    ),
                    (host, ', '.join(open_ports), json.dumps(vulns))
                )
                conn.commit()
                cur.close()
                conn.close()
            except Exception as e:
                print(f"Error inserting into database: {e}")

if __name__ == '__main__':
    for subnet in subnets:
        scan_network(subnet)
