import nmap
import json
import os
import psycopg2

# Load configuration
with open('config.json', 'r') as f:
    config = json.load(f)
subnets = config['subnets']

# Database credentials from environment variables
DB_HOST = os.environ.get('DB_HOST')
DB_USER = os.environ.get('DB_USER')
DB_PASSWORD = os.environ.get('DB_PASSWORD')
DB_NAME = os.environ.get('DB_NAME')

def scan_network(subnet):
    nm = nmap.PortScanner()
    nm.scan(hosts=subnet, arguments='-sn')  # -sn for ping scan to discover hosts

    for host in nm.all_hosts():
        if nm[host].state() == 'up':
            # Perform a more detailed scan on live hosts
            nm.scan(hosts=host, arguments='-sV')  # -sV for service version detection
            open_ports = []
            for proto in nm[host].all_protocols():
                lport = nm[host][proto].keys()
                for port in lport:
                    if nm[host][proto][port]['state'] == 'open':
                        open_ports.append(str(port))

            # Store the results in the database
            try:
                conn = psycopg2.connect(host=DB_HOST, database=DB_NAME, user=DB_USER, password=DB_PASSWORD)
                cur = conn.cursor()
                cur.execute("INSERT INTO scan_results (ip, open_ports) VALUES (%s, %s)", (host, ', '.join(open_ports)))
                conn.commit()
                cur.close()
                conn.close()
            except Exception as e:
                print(f"Error inserting into database: {e}")

if __name__ == '__main__':
    for subnet in subnets:
        scan_network(subnet)
